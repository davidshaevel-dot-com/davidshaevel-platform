# Prometheus Configuration for DavidShaevel.com Platform
# This configuration defines how Prometheus scrapes metrics from the platform services
#
# RENDERED FROM TEMPLATE BY TERRAFORM
# This is the output from terraform templatefile() to verify correct rendering

global:
  scrape_interval: 15s      # Scrape metrics every 15 seconds
  evaluation_interval: 15s  # Evaluate alerting rules every 15 seconds
  external_labels:
    environment: 'dev'
    platform: 'davidshaevel'

# Scrape configuration for all services
scrape_configs:
  # Backend API metrics (NestJS + prom-client)
  - job_name: 'backend'
    metrics_path: '/api/metrics'
    dns_sd_configs:
      - names:
          - 'backend.davidshaevel.local'
        type: 'SRV'
    relabel_configs:
      - source_labels: [job]
        target_label: service
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'nodejs_.*|backend_.*|process_.*|http_request.*|db_query.*'
        action: keep

  # Frontend application metrics (Next.js + prom-client)
  - job_name: 'frontend'
    metrics_path: '/api/metrics'
    dns_sd_configs:
      - names:
          - 'frontend.davidshaevel.local'
        type: 'SRV'
    relabel_configs:
      - source_labels: [job]
        target_label: service
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'nodejs_.*|frontend_.*|process_.*'
        action: keep

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    relabel_configs:
      - source_labels: [job]
        target_label: service
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^(up|prometheus_build_info|prometheus_config_.*|prometheus_engine_.*|prometheus_http_.*|prometheus_notifications_.*|prometheus_rule_.*|prometheus_target_.*|prometheus_tsdb_.*)$'
        action: keep
